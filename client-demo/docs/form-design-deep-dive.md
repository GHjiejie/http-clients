# 表单设计深度指南

> 面向经验型前端，围绕 KISS / DRY / YAGNI / SOLID，把表单需求拆解为可实现、可测试、可扩展的步骤。

## 设计原则
- KISS：优先直观方案，避免过度封装；规则和文案集中配置，UI 只消费结果。
- DRY：字段定义、文案、校验规则单一来源；序列化/反序列化抽为纯函数复用。
- YAGNI：只实现当前需要的校验/联动，后续按需求增量；避免未用的“通用层”。
- SOLID：字段组件单一职责；验证器通过接口组合；可见性/必填判定解耦 UI；依赖抽象（校验器、数据源可注入）。

## 需求与数据建模
- 为每个字段列出：类型（标量/枚举/数组/日期）、约束（必填/长度/范围/格式）、业务规则（互斥/依赖/只读条件）。
- 明确空值语义：`""` / `null` / `undefined` / `0` / `false` 各自含义，与后端契约对齐。
- 编辑态回填/提交格式：日期（ISO/时间戳）、金额（分/元/小数位）、枚举（value/label）、文件（ID/URL/元信息）。
- 字段依赖矩阵：哪些字段驱动显示/必填/默认值，避免逻辑散落；复杂依赖可用规则表或简单状态机。

## 显示/隐藏与必填联动
- 建立规则函数 `isVisible(form)` / `isRequired(form)`，集中管理，UI 层仅消费布尔结果。
- 隐藏字段的值策略：保留（草稿场景）或清空（防误提交），全局统一。
- 多条件联动：用规则表驱动，减少模板内嵌套 `v-if`；必要时缓存规则计算结果以降频。

## 校验策略
- 同步：必填、长度、格式、范围；异步：唯一性、服务端策略（配额/黑名单）。
- 触发时机：
  - onChange（配合防抖）用于实时格式提示。
  - onBlur 减少打扰，适合单字段校验。
  - onSubmit 兜底必做，汇总首条错误并聚焦。
- 错误策略：按优先级返回首条错误，文案与规则绑定（DRY）；多规则时按序短路或汇总需明确。
- 前后端对齐：前端仅做体验校验，权威校验在后端；错误码映射到字段，避免“通用失败”。

## 数据流与序列化
- 提交策略：全量字段 vs 仅脏字段；确保 `0` / `false` 不被误删。
- 统一序列化/反序列化：日期（时区/格式）、金额（小数位/分转元）、文件（ID/URL）；实现为纯函数便于测试。
- 自动修正：提交前裁剪空白、全角半角转换、去除不可见字符；需可逆或提示用户。

## 交互与可用性
- 键盘与可访问性：`label for`、Tab 顺序、Enter 提交、Esc 取消；ARIA 对错误/loading/禁用的暴露。
- 输入优化：合理的 `type`/`inputmode`（tel/email/decimal）、自动填充、粘贴校验；长文本支持字数统计与溢出提示。
- 错误呈现：就近展示 + 聚焦首个错误；长表单支持滚动定位；全局提示与局部提示不冲突。
- Loading/禁用：提交时禁用按钮/相关字段，防重复提交；长耗时显示进度或取消能力。

## 状态管理
- 字段状态：`value`、`touched`、`dirty`、`error`、`disabled/readOnly`；表单状态：`loading/submitting/locked`。
- 防重复：节流/防抖或提交 token 幂等；并发提交的覆盖/排队策略需一致。
- 重置策略：回初始值或清空；编辑态重置保留回填值；草稿保存区分“草稿”与“已提交”。

## 安全与健壮性
- 假设输入不可信：前端校验不代替后端；输出转义防 XSS。
- 上传：类型/大小/页数白名单，前端预检 + 后端复检；失败提供重试或重新选择。
- 防注入/滥用：富文本/Markdown 安全渲染；接口调用节流/签名/权限校验。

## 组件化与抽象
- 复用基础字段组件，单一职责，不夹带业务提交；通过插槽/渲染函数扩展外观。
- 验证器接口简洁：接受值与上下文，返回错误或空；支持同步/异步组合；避免“胖组件” props。
- Schema 驱动：字段定义、规则、文案集中配置，UI 只消费；减少重复并便于演进。

## 性能与体验优化
- 大表单：分段加载、折叠或虚拟化；按字段订阅减少全量重渲；受控输入配合防抖。
- 视觉稳定：预留错误区域避免跳动；loading 占位减少 reflow；异步校验的并发控制（取消旧请求或用最新结果覆盖）。

## 可测试性
- 单测：规则函数（边界/非法）、序列化/反序列化、联动可见/必填。
- 集成/E2E：主路径（填写-提交-错误-修正-成功）、异步校验失败/恢复、网络慢/失败下的 loading 与错误提示。
- Mock：校验器/数据源可注入，测试不依赖真实后端。

## 工程实践与落地
- 类型契约：使用 OpenAPI 生成类型（如 `openapi-typescript`），提交前对照契约。
- 迭代策略：先最小可用，再按反馈补充异步校验与无障碍细节，避免预留未用功能。
- 文档与示例：在组件/Hook 旁放简短用例，说明必填字段、触发时机、错误处理方式；保持文档与代码同步。

## 实施检查清单
- [ ] 字段清单与约束已对齐后端
- [ ] 可见性/必填规则集中化
- [ ] 校验触发策略明确且有兜底
- [ ] 序列化/反序列化函数可测试
- [ ] 提交路径防重复且有 loading 提示
- [ ] 错误提示就近且可聚焦首个错误
- [ ] 上传/富文本具备安全防护
- [ ] 规则与文案单一来源（DRY）
- [ ] 关键路径 E2E 覆盖
